---
title: JavaScript代码片段
description: AILabTools API JavaScript代码片段和示例
---

# JavaScript代码片段

## 基础API调用

### 发型编辑Pro

```javascript
async function hairstyleEditorPro(imageFile, options = {}) {
  // 将图片转换为Base64
  const base64Image = await fileToBase64(imageFile);
  
  const response = await fetch('https://api.ailabtools.com/v1/hairstyle-editor-pro', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_API_KEY',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      image: base64Image,
      hairstyle: options.hairstyle || 'short',
      hair_color: options.hair_color || 'black'
    })
  });
  
  const result = await response.json();
  
  if (result.error_code !== 0) {
    throw new Error(result.error_detail.message);
  }
  
  return result.result.task_id;
}

// 辅助函数：文件转Base64
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = () => resolve(reader.result);
    reader.onerror = error => reject(error);
  });
}
```

### 异步任务查询

```javascript
async function pollTaskResult(taskId, maxAttempts = 100) {
  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    const response = await fetch(
      `https://api.ailabtools.com/v1/async-task-results?task_id=${taskId}`,
      {
        headers: {
          'Authorization': 'Bearer YOUR_API_KEY'
        }
      }
    );
    
    const result = await response.json();
    
    if (result.error_code !== 0) {
      throw new Error(result.error_detail.message);
    }
    
    const status = result.result.status;
    
    if (status === 'completed') {
      return result.result.result_image;
    } else if (status === 'failed') {
      throw new Error('任务处理失败');
    }
    
    // 等待5秒后重试
    await new Promise(resolve => setTimeout(resolve, 5000));
  }
  
  throw new Error('查询超时');
}
```

### 人脸分析

```javascript
async function faceAnalysis(imageFile) {
  const base64Image = await fileToBase64(imageFile);
  
  const response = await fetch('https://api.ailabtools.com/v1/face-analysis', {
    method: 'POST',
    headers: {
      'Authorization': 'Bearer YOUR_API_KEY',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      image: base64Image
    })
  });
  
  const result = await response.json();
  
  if (result.error_code !== 0) {
    throw new Error(result.error_detail.message);
  }
  
  return result.result;
}
```

## 完整工作流程

```javascript
async function processHairstyle(imageFile, options = {}) {
  try {
    // 1. 人脸分析验证
    const faceResult = await faceAnalysis(imageFile);
    
    if (faceResult.face_num === 0) {
      throw new Error('未检测到人脸');
    }
    
    if (faceResult.face_num > 1) {
      throw new Error('检测到多个人脸');
    }
    
    const face = faceResult.face_info[0];
    if (face.face_angle > 30) {
      throw new Error('人脸角度过大');
    }
    
    if (face.face_proportion < 0.1) {
      throw new Error('人脸占比过小');
    }
    
    // 2. 调用发型编辑API
    const taskId = await hairstyleEditorPro(imageFile, options);
    
    // 3. 轮询获取结果
    const resultImage = await pollTaskResult(taskId);
    
    return resultImage;
    
  } catch (error) {
    console.error('处理失败:', error.message);
    throw error;
  }
}

// 使用示例
const imageInput = document.getElementById('imageInput');
imageInput.addEventListener('change', async (event) => {
  const file = event.target.files[0];
  if (file) {
    try {
      const result = await processHairstyle(file, {
        hairstyle: 'short',
        hair_color: 'black'
      });
      
      // 显示结果
      const resultImg = document.getElementById('resultImage');
      resultImg.src = result;
      
    } catch (error) {
      alert('处理失败: ' + error.message);
    }
  }
});
```

## 错误处理

```javascript
class AILabToolsError extends Error {
  constructor(errorCode, message) {
    super(message);
    this.name = 'AILabToolsError';
    this.errorCode = errorCode;
  }
}

function handleAPIError(response) {
  if (response.error_code !== 0) {
    const errorMessages = {
      1001: '请求参数有误',
      1002: '图片格式不支持',
      1003: '图片大小超限',
      1004: '图片分辨率不符合要求',
      1005: '未检测到人脸',
      1006: '检测到多个人脸',
      1007: '人脸角度过大',
      1008: '人脸占比过小',
      2001: 'API密钥无效',
      2002: '权限不足',
      3001: '任务不存在',
      3002: '任务已过期',
      3003: '任务处理失败',
      4001: '请求过于频繁',
      5001: '服务器错误'
    };
    
    const message = errorMessages[response.error_code] || response.error_detail.message;
    throw new AILabToolsError(response.error_code, message);
  }
}
```

## 图片预处理

```javascript
async function preprocessImage(file) {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const img = new Image();
    
    img.onload = function() {
      // 计算最佳尺寸
      const maxSize = 1200;
      let { width, height } = img;
      
      if (width > maxSize || height > maxSize) {
        if (width > height) {
          height = (height * maxSize) / width;
          width = maxSize;
        } else {
          width = (width * maxSize) / height;
          height = maxSize;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      
      // 绘制并压缩
      ctx.drawImage(img, 0, 0, width, height);
      
      canvas.toBlob((blob) => {
        resolve(blob);
      }, 'image/jpeg', 0.85);
    };
    
    img.src = URL.createObjectURL(file);
  });
}
```

## 批量处理

```javascript
async function batchProcessImages(imageFiles, options = {}, concurrency = 3) {
  const results = [];
  const chunks = [];
  
  // 分批处理
  for (let i = 0; i < imageFiles.length; i += concurrency) {
    chunks.push(imageFiles.slice(i, i + concurrency));
  }
  
  for (const chunk of chunks) {
    const promises = chunk.map(async (file) => {
      try {
        const processedFile = await preprocessImage(file);
        const result = await processHairstyle(processedFile, options);
        return { success: true, result };
      } catch (error) {
        return { success: false, error: error.message };
      }
    });
    
    const chunkResults = await Promise.all(promises);
    results.push(...chunkResults);
    
    // 避免触发速率限制
    await new Promise(resolve => setTimeout(resolve, 1000));
  }
  
  return results;
}
```

## 缓存实现

```javascript
class APICache {
  constructor(maxSize = 100) {
    this.cache = new Map();
    this.maxSize = maxSize;
  }
  
  generateKey(imageData, options) {
    const hash = this.hashString(imageData + JSON.stringify(options));
    return `cache_${hash}`;
  }
  
  async get(key) {
    const cached = this.cache.get(key);
    if (cached && Date.now() - cached.timestamp < 24 * 60 * 60 * 1000) {
      return cached.data;
    }
    return null;
  }
  
  set(key, data) {
    if (this.cache.size >= this.maxSize) {
      const firstKey = this.cache.keys().next().value;
      this.cache.delete(firstKey);
    }
    
    this.cache.set(key, {
      data,
      timestamp: Date.now()
    });
  }
  
  hashString(str) {
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    return hash;
  }
}

const apiCache = new APICache();

async function processHairstyleWithCache(imageFile, options = {}) {
  const base64Image = await fileToBase64(imageFile);
  const cacheKey = apiCache.generateKey(base64Image, options);
  
  // 尝试从缓存获取
  const cached = await apiCache.get(cacheKey);
  if (cached) {
    return cached;
  }
  
  // 调用API
  const result = await processHairstyle(imageFile, options);
  
  // 缓存结果
  apiCache.set(cacheKey, result);
  
  return result;
}
```
