---
title: 错误处理
description: AILabTools API错误处理最佳实践
---

# 错误处理

本指南将帮助您正确处理AILabTools API可能遇到的各种错误情况。

## 错误响应格式

所有API错误都遵循统一的响应格式：

```json
{
  "request_id": "req_123456789",
  "log_id": "log_987654321",
  "error_code": 1001,
  "error_detail": {
    "status_code": 400,
    "code": "INVALID_PARAMETER",
    "code_message": "参数错误",
    "message": "请求参数无效：image字段不能为空"
  }
}
```

### 字段说明

| 字段 | 描述 |
|------|------|
| `request_id` | 请求ID，用于问题定位 |
| `log_id` | 日志ID，用于技术支持 |
| `error_code` | 错误码，用于程序判断 |
| `error_detail.status_code` | HTTP状态码 |
| `error_detail.code` | 错误类型代码 |
| `error_detail.code_message` | 错误类型描述 |
| `error_detail.message` | 详细错误信息 |

## 错误分类

### 1. 客户端错误 (4xx)

#### 参数错误 (1001)
```javascript
// 检查请求参数
if (response.error_code === 1001) {
  console.error('参数错误:', response.error_detail.message);
  // 检查必需参数是否缺失
  // 检查参数格式是否正确
}
```

#### 图片格式错误 (1002)
```javascript
if (response.error_code === 1002) {
  console.error('图片格式不支持');
  // 转换为支持的格式：PNG、JPG、JPEG
}
```

#### 图片大小错误 (1003)
```javascript
if (response.error_code === 1003) {
  console.error('图片大小超限');
  // 压缩图片到3MB以下
}
```

#### 人脸检测错误 (1005-1008)
```javascript
if ([1005, 1006, 1007, 1008].includes(response.error_code)) {
  const errorMessages = {
    1005: '未检测到人脸',
    1006: '检测到多个人脸',
    1007: '人脸角度过大',
    1008: '人脸占比过小'
  };
  console.error(errorMessages[response.error_code]);
  // 建议用户重新上传合适的图片
}
```

### 2. 认证错误 (401/403)

#### 认证失败 (2001)
```javascript
if (response.error_code === 2001) {
  console.error('API密钥无效');
  // 检查API密钥是否正确
  // 重新生成API密钥
}
```

#### 权限不足 (2002)
```javascript
if (response.error_code === 2002) {
  console.error('权限不足');
  // 升级账户或联系客服
}
```

### 3. 服务器错误 (5xx)

#### 服务器内部错误 (5001)
```javascript
if (response.error_code === 5001) {
  console.error('服务器错误');
  // 稍后重试
  // 实现指数退避重试
}
```

## 重试策略

### 1. 指数退避重试

```javascript
async function callAPIWithRetry(apiCall, maxRetries = 3) {
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      const result = await apiCall();
      
      // 检查是否成功
      if (result.error_code === 0) {
        return result;
      }
      
      // 对于客户端错误，不进行重试
      if (result.error_code >= 1001 && result.error_code <= 2003) {
        throw new Error(result.error_detail.message);
      }
      
      // 对于服务器错误，进行重试
      if (result.error_code >= 5001) {
        const delay = Math.pow(2, attempt) * 1000; // 指数退避
        console.log(`重试 ${attempt + 1}/${maxRetries}，等待 ${delay}ms`);
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      
      throw new Error(result.error_detail.message);
      
    } catch (error) {
      if (attempt === maxRetries - 1) {
        throw error;
      }
      
      // 网络错误也进行重试
      if (error.name === 'NetworkError' || error.code === 'NETWORK_ERROR') {
        const delay = Math.pow(2, attempt) * 1000;
        await new Promise(resolve => setTimeout(resolve, delay));
        continue;
      }
      
      throw error;
    }
  }
}
```

### 2. 异步任务轮询重试

```javascript
async function pollTaskResult(taskId, maxAttempts = 100) {
  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    try {
      const response = await fetch(
        `https://api.ailabtools.com/v1/async-task-results?task_id=${taskId}`,
        {
          headers: {
            'Authorization': 'Bearer YOUR_API_KEY'
          }
        }
      );
      
      const result = await response.json();
      
      if (result.error_code !== 0) {
        // 处理错误
        if (result.error_code === 3001) {
          throw new Error('任务不存在');
        } else if (result.error_code === 3002) {
          throw new Error('任务已过期');
        } else {
          throw new Error(result.error_detail.message);
        }
      }
      
      const status = result.result.status;
      
      if (status === 'completed') {
        return result.result.result_image;
      } else if (status === 'failed') {
        throw new Error('任务处理失败');
      }
      
      // 等待5秒后重试
      await new Promise(resolve => setTimeout(resolve, 5000));
      
    } catch (error) {
      if (attempt === maxAttempts - 1) {
        throw new Error('查询超时');
      }
      
      // 网络错误重试
      if (error.name === 'NetworkError') {
        await new Promise(resolve => setTimeout(resolve, 5000));
        continue;
      }
      
      throw error;
    }
  }
}
```

## 用户友好的错误提示

### 1. 错误消息映射

```javascript
const ERROR_MESSAGES = {
  1001: '请求参数有误，请检查输入',
  1002: '图片格式不支持，请使用PNG、JPG或JPEG格式',
  1003: '图片太大，请使用小于3MB的图片',
  1004: '图片分辨率不符合要求',
  1005: '未检测到人脸，请确保图片包含清晰的人脸',
  1006: '检测到多个人脸，请使用只包含一个人脸的图片',
  1007: '人脸角度过大，请使用正面照片',
  1008: '人脸太小，请使用人脸占比更大的图片',
  2001: 'API密钥无效，请检查密钥',
  2002: '权限不足，请升级账户',
  2003: '账户被禁用，请联系客服',
  3001: '任务不存在',
  3002: '任务已过期，请重新提交',
  3003: '任务处理失败，请重试',
  4001: '请求过于频繁，请稍后重试',
  5001: '服务器错误，请稍后重试',
  5002: '服务暂时不可用，请稍后重试'
};

function getErrorMessage(errorCode) {
  return ERROR_MESSAGES[errorCode] || '未知错误，请联系技术支持';
}
```

### 2. 错误处理组件

```javascript
// React组件示例
function ErrorHandler({ error, onRetry }) {
  const getErrorIcon = (errorCode) => {
    if (errorCode >= 1001 && errorCode <= 1008) {
      return '📷'; // 图片相关错误
    } else if (errorCode >= 2001 && errorCode <= 2003) {
      return '🔑'; // 认证相关错误
    } else if (errorCode >= 5001) {
      return '🔧'; // 服务器错误
    }
    return '❌';
  };

  return (
    <div className="error-container">
      <div className="error-icon">
        {getErrorIcon(error.error_code)}
      </div>
      <div className="error-content">
        <h3>处理失败</h3>
        <p>{getErrorMessage(error.error_code)}</p>
        <div className="error-actions">
          <button onClick={onRetry}>重试</button>
          <button onClick={() => window.location.reload()}>刷新页面</button>
        </div>
      </div>
    </div>
  );
}
```

## 日志记录

### 1. 错误日志

```javascript
function logError(error, context = {}) {
  const errorLog = {
    timestamp: new Date().toISOString(),
    error_code: error.error_code,
    error_message: error.error_detail.message,
    request_id: error.request_id,
    log_id: error.log_id,
    context: context
  };
  
  // 发送到日志服务
  console.error('API Error:', errorLog);
  
  // 可以发送到外部日志服务
  // sendToLogService(errorLog);
}
```

### 2. 性能监控

```javascript
async function callAPIWithMonitoring(apiCall, apiName) {
  const startTime = Date.now();
  
  try {
    const result = await apiCall();
    const duration = Date.now() - startTime;
    
    // 记录成功调用
    console.log(`${apiName} 调用成功，耗时: ${duration}ms`);
    
    return result;
  } catch (error) {
    const duration = Date.now() - startTime;
    
    // 记录失败调用
    console.error(`${apiName} 调用失败，耗时: ${duration}ms`, error);
    
    throw error;
  }
}
```

## 最佳实践

### 1. 前端验证

在调用API前进行前端验证：

```javascript
function validateBeforeUpload(file) {
  const errors = [];
  
  // 检查文件大小
  if (file.size > 3 * 1024 * 1024) {
    errors.push('图片大小不能超过3MB');
  }
  
  // 检查文件类型
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png'];
  if (!allowedTypes.includes(file.type)) {
    errors.push('只支持JPG、JPEG、PNG格式');
  }
  
  return errors;
}
```

### 2. 优雅降级

```javascript
async function processImage(imageFile) {
  try {
    // 尝试使用AI处理
    const result = await callHairstyleAPI(imageFile);
    return result;
  } catch (error) {
    if (error.error_code === 1005) {
      // 如果检测不到人脸，提供手动裁剪选项
      return showManualCropDialog(imageFile);
    }
    
    // 其他错误，显示错误信息
    showErrorMessage(error);
  }
}
```

### 3. 用户引导

```javascript
function showErrorGuidance(errorCode) {
  const guidance = {
    1005: '请确保图片中有清晰的人脸，建议使用正面照片',
    1006: '请选择只包含一个人脸的图片',
    1007: '请使用正面或接近正面的照片',
    1008: '请选择人脸占比更大的图片，建议人脸占图片20%-50%'
  };
  
  return guidance[errorCode] || '请检查图片是否符合要求';
}
```

## 联系支持

如果遇到无法解决的错误，请：

1. 记录完整的错误响应（包括request_id和log_id）
2. 描述您执行的操作步骤
3. 提供相关的代码片段
4. 联系技术支持团队

<CTA href="mailto:support@ailabtools.com">
  联系技术支持
</CTA>
