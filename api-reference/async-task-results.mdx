---
title: 异步任务查询
api: "GET /api/async-task-results"
description: 查询异步任务的处理结果
openapi: "3.0.0"
servers:
  - url: "https://api.ailabtools.com/v1"
    description: "生产环境"
info:
  title: "AILabTools API"
  version: "1.0.0"
  description: "基于稳定扩散模型的发型编辑Pro功能API"
components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "请输入您的API密钥，格式为 sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
  schemas:
    AsyncTaskResponse:
      type: object
      properties:
        request_id:
          type: string
          description: "请求ID"
          example: "req_123456789"
        log_id:
          type: string
          description: "日志ID"
          example: "log_987654321"
        error_code:
          type: integer
          description: "错误码，0表示成功"
          example: 0
        result:
          type: object
          properties:
            task_id:
              type: string
              description: "异步任务ID"
              example: "task_abcdef123456"
            status:
              type: string
              enum: ["pending", "processing", "completed", "failed"]
              description: "任务状态"
              example: "completed"
            result_image:
              type: string
              format: byte
              description: "处理结果图片（Base64编码）"
              example: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
paths:
  /async-task-results:
    get:
      summary: "异步任务查询"
      description: "查询异步任务的处理结果，获取最终的图片处理结果"
      security:
        - BearerAuth: []
      parameters:
        - name: task_id
          in: query
          required: true
          schema:
            type: string
          description: "异步任务ID，从其他API响应中获取"
          example: "task_abcdef123456"
      responses:
        "200":
          description: "请求成功"
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AsyncTaskResponse"
              examples:
                completed:
                  summary: "任务完成"
                  value:
                    request_id: "req_123456789"
                    log_id: "log_987654321"
                    error_code: 0
                    result:
                      task_id: "task_abcdef123456"
                      status: "completed"
                      result_image: "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
                processing:
                  summary: "任务处理中"
                  value:
                    request_id: "req_123456789"
                    log_id: "log_987654321"
                    error_code: 0
                    result:
                      task_id: "task_abcdef123456"
                      status: "processing"
                failed:
                  summary: "任务失败"
                  value:
                    request_id: "req_123456789"
                    log_id: "log_987654321"
                    error_code: 0
                    result:
                      task_id: "task_abcdef123456"
                      status: "failed"
        "400":
          description: "请求参数错误"
          content:
            application/json:
              schema:
                type: object
                properties:
                  error_code:
                    type: integer
                    example: 1001
                  error_detail:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "task_id参数缺失"
        "401":
          description: "认证失败"
          content:
            application/json:
              schema:
                type: object
                properties:
                  error_code:
                    type: integer
                    example: 2001
                  error_detail:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "API密钥无效或已过期"
        "404":
          description: "任务不存在"
          content:
            application/json:
              schema:
                type: object
                properties:
                  error_code:
                    type: integer
                    example: 2001
                  error_detail:
                    type: object
                    properties:
                      message:
                        type: string
                        example: "任务不存在或已过期"
---

# 异步任务查询

查询异步任务的处理结果，获取最终的图片处理结果。

<Tip>
对于异步接口，调用API后返回的结果不是真实的请求结果，您需要保存返回结果中的`task_id`，然后调用此接口获取真实的请求结果。
</Tip>

<RequestExample>
```bash
curl -X GET "https://api.ailabtools.com/v1/async-task-results?task_id=task_abcdef123456" \
  -H "Authorization: Bearer YOUR_API_KEY"
```
</RequestExample>

<ResponseExample>
```json
{
  "request_id": "req_123456789",
  "log_id": "log_987654321",
  "error_code": 0,
  "result": {
    "task_id": "task_abcdef123456",
    "status": "completed",
    "result_image": "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQ..."
  }
}
```
</ResponseExample>

## 请求参数

| 参数名 | 类型 | 必需 | 描述 |
|--------|------|------|------|
| `task_id` | string | 是 | 异步任务ID，从其他API响应中获取 |

## 响应参数

| 字段 | 类型 | 描述 |
|------|------|------|
| `request_id` | string | 请求ID |
| `log_id` | string | 日志ID |
| `error_code` | number | 错误码，0表示成功 |
| `result.task_id` | string | 异步任务ID |
| `result.status` | string | 任务状态 |
| `result.result_image` | string | 处理结果图片（Base64编码） |

### 任务状态

| 状态 | 描述 |
|------|------|
| `pending` | 等待处理 |
| `processing` | 处理中 |
| `completed` | 处理完成 |
| `failed` | 处理失败 |

<Warning>
异步任务结果有效期为24小时。建议每5秒查询一次异步任务结果。
</Warning>

## 错误码

| 错误码 | 描述 |
|--------|------|
| 0 | 成功 |
| 1001 | 参数错误 |
| 2001 | 任务不存在 |
| 2002 | 任务已过期 |
| 2003 | 任务处理失败 |

## 使用示例

<Tabs>
<Tab title="JavaScript">
```javascript
async function pollTaskResult(taskId) {
  const maxAttempts = 100; // 最多尝试100次
  let attempts = 0;
  
  while (attempts < maxAttempts) {
    const response = await fetch(
      `https://api.ailabtools.com/v1/async-task-results?task_id=${taskId}`,
      {
        headers: {
          'Authorization': 'Bearer YOUR_API_KEY'
        }
      }
    );
    
    const result = await response.json();
    
    if (result.result.status === 'completed') {
      return result.result.result_image;
    } else if (result.result.status === 'failed') {
      throw new Error('任务处理失败');
    }
    
    // 等待5秒后重试
    await new Promise(resolve => setTimeout(resolve, 5000));
    attempts++;
  }
  
  throw new Error('查询超时');
}

// 使用示例
const taskId = 'task_abcdef123456';
const resultImage = await pollTaskResult(taskId);
console.log('处理完成:', resultImage);
```
</Tab>

<Tab title="Python">
```python
import requests
import time

def poll_task_result(task_id, max_attempts=100):
    """轮询任务结果"""
    for attempt in range(max_attempts):
        response = requests.get(
            'https://api.ailabtools.com/v1/async-task-results',
            params={'task_id': task_id},
            headers={'Authorization': 'Bearer YOUR_API_KEY'}
        )
        
        result = response.json()
        
        if result['result']['status'] == 'completed':
            return result['result']['result_image']
        elif result['result']['status'] == 'failed':
            raise Exception('任务处理失败')
        
        # 等待5秒后重试
        time.sleep(5)
    
    raise Exception('查询超时')

# 使用示例
task_id = 'task_abcdef123456'
result_image = poll_task_result(task_id)
print('处理完成:', result_image)
```
</Tab>

<Tab title="cURL">
```bash
# 查询任务状态
curl -X GET "https://api.ailabtools.com/v1/async-task-results?task_id=task_abcdef123456" \
  -H "Authorization: Bearer YOUR_API_KEY"

# 轮询脚本示例
#!/bin/bash
task_id="task_abcdef123456"
max_attempts=100

for i in $(seq 1 $max_attempts); do
  response=$(curl -s -X GET \
    "https://api.ailabtools.com/v1/async-task-results?task_id=$task_id" \
    -H "Authorization: Bearer YOUR_API_KEY")
  
  status=$(echo $response | jq -r '.result.status')
  
  if [ "$status" = "completed" ]; then
    echo "任务完成"
    echo $response | jq -r '.result.result_image' > result.jpg
    break
  elif [ "$status" = "failed" ]; then
    echo "任务失败"
    exit 1
  fi
  
  echo "等待中... ($i/$max_attempts)"
  sleep 5
done
```
</Tab>
</Tabs>
